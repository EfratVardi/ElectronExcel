<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>הגדרות המערכת</title>
</head>

<body onload="onLoad()">

    <link href="StyleSheets/UserStyleSheet.css" rel="stylesheet" />
    <link href="StyleSheets/MainStyleSheet.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/ag-grid-community.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/xlsx.full.min.js"></script>

    <script>
        var gridOptions
        // [{
        //     "id": 0,
        //     "name": "",
        //     "points": 0,
        //     "sum": 1,
        //     "class": false
        // }
        // ]
        var defaultTask = [{
            "id": 0,
            "name": "משימה ראשונה",
            "points": 100,
            "sum": 1,
            "class": false
        },
        {
            "id": 1,
            "name": "משימה שנייה",
            "points": 50,
            "sum": 2,
            "class": false
        }
        ]
        var tasks = [];
        var excelTasks = []
        const FileType = {
            EXCEL: "excel",
            TEXT: "text"
        };
        function onLoad() {
            document.getElementById("background").style.backgroundImage = "url('resources/pinkBackground4.gif')"
            gridOptions = {
                columnDefs: [
                    { headerName: 'קוד', field: "id", hide: true },
                    { headerName: "שם", field: "name", editable: true, minWidth: 300 },
                    { headerName: "נקודות", field: "points", editable: true },
                    { headerName: "כמות", field: "sum", editable: true },
                    {
                        headerName: "כיתה", field: "class",
                        cellRenderer: 'agCheckboxCellRenderer',
                        cellEditor: 'agCheckboxCellEditor',
                        editable: true,
                    }
                ],
                rowData: defaultTask,
                onFirstDataRendered: onFirstDataRendered,

            };
            var gridDiv = document.querySelector('#tasksGrid');
            new agGrid.Grid(gridDiv, gridOptions);

            const numPosition = document.getElementById('numPosition');
            const numStudents = document.getElementById('numStudents');
            const numClasses = document.getElementById('numClasses');


            numPosition.addEventListener('input', function () {
                const inputElements1 = numStudents.querySelectorAll('input');
                const inputElements2 = numClasses.querySelectorAll('input');

                inputElements1.forEach((inputElement) => {
                    numStudents.removeChild(inputElement);
                });
                inputElements2.forEach((inputElement) => {
                    numClasses.removeChild(inputElement);
                });
                for (let i = 1; i <= numPosition.value; i++) {
                    const newInput1 = document.createElement('input');
                    newInput1.type = 'number';
                    newInput1.id = 'numStudents' + i;
                    newInput1.className = "form-control"
                    newInput1.value = 0
                    numStudents.appendChild(newInput1);
                    const newInput2 = document.createElement('input');
                    newInput2.type = 'number';
                    newInput2.id = 'numClasses' + i;
                    newInput2.className = "form-control"
                    newInput2.value = 0
                    numClasses.appendChild(newInput2);
                }
            });
        }

        function create() {
            fixTasks()

            const numPosition = document.getElementById('numPosition').value;
            let numtasks = tasks.length;
            let countInPage = Math.floor(44 / numtasks)
            let countBlank = 44 % numtasks
            let interval = 44 - countBlank

            for (let i = 1; i <= numPosition; i++) {
                let numStudents = document.getElementById('numStudents' + numPosition).value;
                addToExcel(i, numStudents);
                downLoadExcel(i, "uniqTasks", FileType.EXCEL)
                addBlank(countBlank, interval)
                downLoadExcel(i, "כרטיסים", FileType.TEXT)
            }
        }

        function fixTasks() {
            tasks = [];
            gridOptions.rowData.forEach(element => {
                for (let i = 0; i < element.sum; i++) {
                    tasks.push({ "name": element.name, "points": element.points })
                }
            });
        }

        function addToExcel(numPosition, numStudents) {
            //אין תמיכה במשימה כיתתית
            excelTasks=[]
            let prefix = ('5' + numPosition) * 10000000
            let t = 1;
            for (let i = 0; i < numStudents; i++) {
                tasks.forEach(task => {
                    excelTasks.push({
                        name: task.name, code: prefix + t, barcode: '*' + (prefix + t) + '*',
                        points: task.points, position: "| " + "עמדה " + numPosition
                    })
                    t++;
                })
            }
        }
        function addBlank(countBlank, interval) {
            const updatedExcelTasks = []; // המערך החדש שיכיל את האובייקטים הרגילים והריקים

            while (excelTasks.length > 0) {
                // חותכים את הקבוצה הבאה מתוך המערך המקורי
                const group = excelTasks.splice(0, interval);

                // מוסיפים את הקבוצה למערך החדש
                updatedExcelTasks.push(...group);

                // מוסיפים את האובייקטים הריקים למערך החדש
                for (let j = 0; j < countBlank; j++) {
                    updatedExcelTasks.push({});
                }
            }

            // עדכון המערך המקורי עם המערך החדש
            excelTasks = updatedExcelTasks;
        }

        function downLoadExcel(numPosition, name, type) {
            if (type === FileType.EXCEL) {
                // Logic for downloading as Excel
                var myFile = name + numPosition + ".xlsx";
                var myWorkSheet = XLSX.utils.json_to_sheet(excelTasks);
                var myWorkBook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(myWorkBook, myWorkSheet, "myWorkSheet");
                XLSX.writeFile(myWorkBook, myFile);
            } else if (type === FileType.TEXT) {
                // Logic for downloading as Unicode Text with headers in English
                const headers = "name\tcode\tbarcode\tpoints\tposition";  // Define the column titles in English
                const rows = excelTasks.map(task =>
                    `${task.name}\t${task.code}\t${task.barcode}\t${task.points}\t${task.position}`
                ).join("\n");

                const textContent = `${headers}\n${rows}`; // Add headers to the text content

                const blob = new Blob([textContent], { type: "text/plain;charset=utf-16" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = name + numPosition + ".txt";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Free up memory
            }
        }


        function onFirstDataRendered(params) {
            gridOptions.api.sizeColumnsToFit({
                defaultMinWidth: 50,
            });
        }
        function New() {
            let data = gridOptions.rowData;
            data.push({
                "id": data[data.length - 1].id + 1,
                "name": "",
                "points": 0,
                "sum": 1,
                "class": false
            })
            gridOptions.api.setRowData(data);
        }

    </script>

    <div class="background" id="background">
        <div class="text">
            <div id="line1">מערכת הפקת אקסלים</div>
            <br />
            <div style="display: flex;">
                <form style="direction: rtl; width: 50%;">
                    <div class="form-row">
                        <div class="form-group col-md-2">
                            <label for="title" class="form-label">עמדות</label>
                            <input type="number" class="form-control" id="numPosition" min="1">
                        </div>

                        <div class="form-group col-md-4" id="numStudents">
                            <label for="numPosition1" class="form-label">מספר בנות בעמדה</label>
                        </div>

                        <div class="form-group col-md-4" id="numClasses">
                            <label for="numPosition1" class="form-label">מספר כיתות בעמדה</label>
                        </div>

                        <div class="form-group col-md-2">
                            <label for="numPosition1" class="form-label">.</label>
                            <button type="button" onclick="create()" class="form-control">התחל</button>
                        </div>
                    </div>
                </form>
                <div style="width:50%;height: 300px;">
                    <button style="border:aliceblue;margin-left: 75%" onclick="New()">הוספת משימה</button>
                    <div id="tasksGrid" style="width:100%;height: 300px;" class="ag-theme-alpine"></div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>