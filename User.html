<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>הגדרות המערכת</title>
</head>

<body onload="onLoad()">

    <link href="StyleSheets/UserStyleSheet.css" rel="stylesheet" />
    <link href="StyleSheets/MainStyleSheet.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/ag-grid-community.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/xlsx.full.min.js"></script>

    <script>
        var gridOptions1
        var gridOptions2

        // [{
        //     "id": 0,
        //     "name": "",
        //     "points": 0,
        //     "sum": 1        // }
        // ]
        var defaultTask1 = [{
            "id": 0,
            "name": "משימה ראשונה",
            "points": 100,
            "sum": 1
        },
        {
            "id": 1,
            "name": "משימה שנייה",
            "points": 50,
            "sum": 2
        }
        ]
        var defaultTask2 = [{
            "id": 0,
            "name": "משימה ראשונה",
            "points": 100,
            "multiple": true
        },
        {
            "id": 1,
            "name": "משימה שנייה",
            "points": 50,
            "multiple": false
        }
        ]
        var tasks = [];
        var excelTasks = []
        var countInPage = 44
        var numtasks
        var countTasksInPage
        var code
        var position

        const FileType = {
            EXCEL: "excel",
            TEXT: "text"
        };

        function onLoad() {
            document.getElementById("background").style.backgroundImage = "url('resources/pinkBackground4.gif')"
            const taskType = document.getElementById('taskType');
            if (taskType.value == "0") {
                gridOptions1 = {
                    columnDefs: [
                        { headerName: 'קוד', field: "id", hide: true },
                        { headerName: "שם", field: "name", editable: true, minWidth: 300 },
                        { headerName: "נקודות", field: "points", editable: true },
                        { headerName: "כמות", field: "sum", editable: true }
                    ],
                    rowData: defaultTask,
                    enableRtl: true,
                    onFirstDataRendered: onFirstDataRendered,
                };
                var gridDiv = document.querySelector('#tasksGrid');
                new agGrid.Grid(gridDiv, gridOptions1);
            }
            else {
                gridOptions2 = {
                    columnDefs: [
                        { headerName: 'קוד', field: "id", hide: true },
                        { headerName: "שם", field: "name", editable: true, minWidth: 300 },
                        { headerName: "נקודות", field: "points", editable: true },
                        { headerName: "הגשה מרובה", field: "multiple", editable: true }
                    ],
                    rowData: defaultTask2,
                    enableRtl: true,
                    onFirstDataRendered: onFirstDataRendered,
                };
                var gridDiv = document.querySelector('#tasksGrid');
                new agGrid.Grid(gridDiv, gridOptions2);
            }


            const numPosition = document.getElementById('numPosition');
            const numStudents = document.getElementById('numStudents');


            numPosition.addEventListener('input', function () {
                const inputElements1 = numStudents.querySelectorAll('input');

                inputElements1.forEach((inputElement) => {
                    numStudents.removeChild(inputElement);
                });

                for (let i = 1; i <= numPosition.value; i++) {
                    const newInput1 = document.createElement('input');
                    newInput1.type = 'number';
                    newInput1.id = 'numStudents' + i;
                    newInput1.className = "form-control"
                    newInput1.value = 0
                    numStudents.appendChild(newInput1);
                }
            });

            taskType.addEventListener('change', function () {
                taskType.value == '1' ?
                    uniqTaskConfig.style.visibility = "hidden" :
                    uniqTaskConfig.style.visibility = "visible";
            })
        }

        function start() {
            taskType.value == "1" ? createTasks() : createUniqTasks();
            showStatistics()
        }

        function createTasks() {

            downLoadExcel("כרטיסים", FileType.TEXT)
            downLoadExcel("uniqTasks", FileType.EXCEL)

        }

        function createUniqTasks() {
            fixTasks()
            let countPosition = document.getElementById('numPosition').value;
            for (let i = 1; i <= countPosition; i++) {
                position = i;
                let numStudents = document.getElementById('numStudents' + position).value * 1.05;
                let countPages = Math.round(numStudents / countTasksInPage)
                addToExcel(countPages);
                downLoadExcel("כרטיסים", FileType.TEXT)
                removeBlanks()
                downLoadExcel("uniqTasks", FileType.EXCEL)
            }
        }

        function fixTasks() {
            tasks = [];
            gridOptions.rowData.forEach(element => {
                for (let i = 0; i < element.sum; i++) {
                    tasks.push({ "name": element.name, "points": element.points })
                }
            });
            numtasks = tasks.length;
            countTasksInPage = Math.floor(countInPage / numtasks)
        }

        function addToExcel(countPages) {
            code = ('5' + position) * 10000000
            excelTasks = []
            for (let i = 0; i < countPages; i++) {
                creatPage()
            }
        }

        function creatPage() {
            for (let i = 0; i < countTasksInPage; i++) {
                addTasks()
            }
            addBlanks();
        }

        function addTasks() {
            tasks.forEach(task => {
                excelTasks.push({
                    name: task.name, code: code, barcode: '*' + (code) + '*',
                    points: task.points, position: "| " + "עמדה " + position
                })
                code++
            })
        }

        function addBlanks() {
            let countBlank = countInPage % numtasks
            for (let i = 0; i < countBlank; i++) {
                excelTasks.push({});
            }
        }

        function removeBlanks() {
            const excelTasks = excelTasks.filter(obj => Object.keys(obj).length > 0);
        }


        function downLoadExcel(name, type) {
            if (type === FileType.EXCEL) {
                // Logic for downloading as Excel
                var myFile = name + position + ".xlsx";
                var myWorkSheet = XLSX.utils.json_to_sheet(excelTasks);
                var myWorkBook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(myWorkBook, myWorkSheet, "myWorkSheet");
                XLSX.writeFile(myWorkBook, myFile);
            } else if (type === FileType.TEXT) {
                // Logic for downloading as Unicode Text with headers in English
                const headers = "name\tcode\tbarcode\tpoints\tposition";  // Define the column titles in English
                const rows = excelTasks.map(task =>
                    `${task.name}\t${task.code}\t${task.barcode}\t${task.points}\t${task.position}`
                ).join("\n");

                const textContent = `${headers}\n${rows}`; // Add headers to the text content

                const blob = new Blob([textContent], { type: "text/plain;charset=utf-16" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = name + position + ".txt";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url); // Free up memory
            }
        }

        function showStatistics() {

        }

        function onFirstDataRendered(params) {
            gridOptions.api.sizeColumnsToFit({
            });
        }

        function newTask() {
            let data = gridOptions.rowData;
            data.push({
                "id": data[data.length - 1].id + 1,
                "name": "",
                "points": 0,
                "sum": 1
            })
            gridOptions.api.setRowData(data);
        }

    </script>

    <div class="background" id="background">
        <div class="text">
            <div id="line1">מערכת הפקת אקסלים</div>
            <br />
            <br />
            <br />
            <br />

            <div style="display: flex;">
                <form style="direction: rtl; width: 50%;">
                    <div class="form-row">
                        <div class="col-md-4">
                            <label for="taskType" class="form-label">סוג המשימות</label>
                            <select class="form-control" id="taskType">
                                <option value="0">צבירה אישית</option>
                                <option value="1">צבירה כללית</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="uniqTaskConfig">
                        <div class="col-md-2">
                            <label for="title" class="form-label">עמדות</label>
                            <input type="number" class="form-control" id="numPosition" min="1">
                        </div>

                        <div class="col-md-4" id="numStudents">
                            <label for="numPosition1" class="form-label">מספר בנות בעמדה</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-2">
                            <label for="numPosition1" class="form-label">.</label>
                            <button type="button" onclick="create()" class="form-control">התחל</button>
                        </div>
                    </div>
                </form>
                <div style="width:50%;height: 300px;">
                    <button style="border:aliceblue;margin-left: 75%" onclick="newTask()">הוספת משימה</button>
                    <div id="tasksGrid" style="width:100%;height: 300px;" class="ag-theme-alpine"></div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>