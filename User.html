<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>הגדרות המערכת</title>
</head>

<body onload="onLoad()">

    <link href="StyleSheets/UserStyleSheet.css" rel="stylesheet" />
    <link href="StyleSheets/MainStyleSheet.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <script src="js/ag-grid-community.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/xlsx.full.min.js"></script>

    <script>
        const table1 = {
            columnDefs: [
                { headerName: 'קוד', field: "id", hide: true },
                { headerName: "שם", field: "name", editable: true },
                { headerName: "נקודות", field: "points", editable: true },
                { headerName: "כמות", field: "sum", editable: true }
            ],
            rowData: [{
                "id": 0,
                "name": "פרטי",
                "points": 100,
                "sum": 1
            },
            {
                "id": 1,
                "name": "פרטי ",
                "points": 50,
                "sum": 2
            }
            ]
        };

        const table2 = {
            columnDefs: [
                { headerName: 'קוד', field: "id", hide: true },
                { headerName: "שם", field: "name", editable: true },
                { headerName: "נקודות", field: "points", editable: true },
                {
                    headerName: "הגשה מרובה", field: "multiple",
                    editable: true,
                    cellRenderer: 'agCheckboxCellRenderer',
                    cellEditor: 'agCheckboxCellEditor',
                    editable: true,
                    suppressKeyboardEvent: (params) => params.event.key === ' ',
                }
            ],
            rowData: [{
                "id": 0,
                "name": "כללי ",
                "points": 100,
                "multiple": true
            },
            {
                "id": 1,
                "name": "כללי ",
                "points": 50,
                "multiple": false
            }
            ]
        };

        var gridOptions = {
            columnDefs: table1.columnDefs,
            rowData: table1.rowData, enableRtl: true
        }
        var tasks = [];
        var excelTasks = []
        var paperRollLengh = 80000;
        var countInPage = 44
        var numtasks
        var countTasksInPage
        var code
        var position = ""

        const FileType = {
            EXCEL: "excel",
            TEXT: "text"
        };

        function onLoad() {
            document.getElementById("background").style.backgroundImage = "url('resources/pinkBackground4.gif')"
            var gridDiv = document.querySelector('#tasksGrid');
            new agGrid.Grid(gridDiv, gridOptions);

            const taskType = document.getElementById('taskType');
            taskType.addEventListener('change', function () {
                taskTypeChange()
            })

            const countPosition = document.getElementById('countPosition');
            const numStudents = document.getElementById('numStudents');
            countPosition.addEventListener('input', function () {
                const inputElements1 = numStudents.querySelectorAll('input');

                inputElements1.forEach((inputElement) => {
                    numStudents.removeChild(inputElement);
                });

                for (let i = 1; i <= countPosition.value; i++) {
                    const newInput1 = document.createElement('input');
                    newInput1.type = 'number';
                    newInput1.id = 'numStudents' + i;
                    newInput1.className = "form-control"
                    newInput1.value = 0
                    numStudents.appendChild(newInput1);
                }
            });
        }

        function taskTypeChange() {
            if (taskType.value == "0") {
                gridOptions.api.setColumnDefs(table1.columnDefs);
                gridOptions.api.setRowData(table1.rowData);
            }
            else {
                gridOptions.api.setColumnDefs(table2.columnDefs);
                gridOptions.api.setRowData(table2.rowData);
            }
            tasks = [];
            excelTasks = []

        }
        function start() {
            taskType.value == "1" ? createTasks() : createUniqTasks();
        }

        function createTasks() {
            code = ('51') * 10000000
            table2.rowData.forEach(task => {
                excelTasks.push({
                    name: task.name, code: code, barcode: '*' + (code) + '*',
                    points: task.points, multiple: task.multiple
                })
                code++
            })
            downLoadExcel("כרטיסים", FileType.TEXT)
            downLoadExcel("uniqTasks", FileType.EXCEL)
            showStatistics()
        }

        function createUniqTasks() {
            fixTasks()
            for (let i = 1; i <= countPosition.value; i++) {
                position = i;
                let numStudents = document.getElementById('numStudents' + position).value * 1.05;
                let countPages = Math.round(numStudents / countTasksInPage)
                addToExcel(countPages);
                downLoadExcel("כרטיסים", FileType.TEXT)
                removeBlanks()
                downLoadExcel("uniqTasks", FileType.EXCEL)
                showStatistics()
            }
        }

        function fixTasks() {
            tasks = [];
            table1.rowData.forEach(element => {
                for (let i = 0; i < element.sum; i++) {
                    tasks.push({ "name": element.name, "points": element.points })
                }
            });
            numtasks = tasks.length;
            countTasksInPage = Math.floor(countInPage / numtasks)
        }

        function addToExcel(countPages) {
            code = ('5' + position) * 10000000
            excelTasks = []
            for (let i = 0; i < countPages; i++) {
                creatPage()
            }
        }

        function creatPage() {
            for (let i = 0; i < countTasksInPage; i++) {
                addTasks()
            }
            addBlanks();
        }

        function addTasks() {
            tasks.forEach(task => {
                excelTasks.push({
                    name: task.name, code: code, barcode: '*' + (code) + '*',
                    points: task.points, position: "| " + "עמדה " + position
                })
                code++
            })
        }

        function addBlanks() {
            let countBlank = countInPage % numtasks
            for (let i = 0; i < countBlank; i++) {
                excelTasks.push({});
            }
        }

        function removeBlanks() {
            excelTasks = excelTasks.filter(obj => Object.keys(obj).length > 0);
        }


        function downLoadExcel(name, type) {
            if (type === FileType.EXCEL) {
                // Logic for downloading as Excel
                var myFile = name + position + ".xlsx";
                var myWorkSheet = XLSX.utils.json_to_sheet(excelTasks);
                var myWorkBook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(myWorkBook, myWorkSheet, "myWorkSheet");
                XLSX.writeFile(myWorkBook, myFile);
            } else if (type === FileType.TEXT) {
                // Logic for downloading as Unicode Text with headers in English
                const headers = "name\tcode\tbarcode\tpoints\tposition";  // Define the column titles in English
                const rows = excelTasks.map(task =>
                    `${task.name}\t${task.code}\t${task.barcode}\t${task.points}\t${task.position}`
                ).join("\n");

                const textContent = `${headers}\n${rows}`; // Add headers to the text content

                const blob = new Blob([textContent], { type: "text/plain;charset=utf-16" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = name + position + ".txt";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }

        function showStatistics() {
            const statistics = document.getElementById("statistics")
            let numRoll
            let numStudents
            if (taskType.value == "0") {
                numRoll = (excelTasks.length * 11) / paperRollLengh
                statistics.innerHTML += "<br>" + "עמדה " + position + ": " + numRoll
            }
            else {
                for (let i = 1; i <= countPosition.value; i++) {
                    numStudents = document.getElementById('numStudents' + i).value;
                    numRoll = (numStudents * excelTasks.length * 11) / paperRollLengh
                    statistics.innerHTML += "עמדה " + i + " גלילים: " + numRoll
                }
            }
        }

        function newTask() {
            let data
            if (taskType.value == "0") {
                data = table1.rowData
                data.push({
                    "id": data[data.length - 1].id + 1,
                    "name": "",
                    "points": 0,
                    "sum": 1
                })
                table1.rowData = data;
            }
            else {
                data = table2.rowData
                data.push({
                    "id": data[data.length - 1].id + 1,
                    "name": "",
                    "points": 0,
                    "multiple": false
                })
                table2.rowData = data;
            }
            gridOptions.api.setRowData(data);
        }
    </script>

    <div class="background" id="background">
        <div class="text">
            <div id="line1">מערכת הפקת אקסלים</div>
            <br />
            <br />
            <br />
            <br />

            <div style="display: flex;">
                <form style="direction: rtl; width: 50%;">
                    <div class="form-row">
                        <div class="col-md-4">
                            <label for="taskType" class="form-label">סוג המשימות</label>
                            <select class="form-control" id="taskType">
                                <option value="0">צבירה אישית</option>
                                <option value="1">צבירה כללית</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="uniqTaskConfig">
                        <div class="col-md-2">
                            <label for="title" class="form-label">עמדות</label>
                            <input type="number" class="form-control" id="countPosition" min="1">
                        </div>

                        <div class="col-md-4" id="numStudents">
                            <label class="form-label">מספר בנות בעמדה</label>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-2">
                            <label for="countPosition1" class="form-label">.</label>
                            <button type="button" onclick="start()" class="form-control">התחל</button>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="col-md-6">
                            <div id="statistics">
                                <b>גלילים</b>
                            </div>
                        </div>
                    </div>
                </form>

                <div style="width:50%;height: 300px;">
                    <button style="border:aliceblue;margin-left: 75%" onclick="newTask()">הוספת משימה</button>
                    <div id="tasksGrid" style="width:100%;height: 300px;" class="ag-theme-alpine"></div>
                </div>
            </div>
        </div>
    </div>

</body>

</html>